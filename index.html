<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Earnings - Animated</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(180deg,#eaf6ff 0%, #ffffff 70%); min-height:100vh; }
    .container { max-width:1000px; margin:28px auto; padding:18px; }

    /* Road and realistic rickshaw */
    .scene { position:relative; height:220px; overflow:hidden; border-radius:14px; background: linear-gradient(180deg,#cfeefd 0%, #ffffff 60%); box-shadow: 0 12px 30px rgba(2,6,23,0.08); }
    .ground { position:absolute; left:0; right:0; bottom:0; height:90px; background: linear-gradient(180deg,#2b2b2b 0%, #111827 100%); }
    .lane { position:absolute; left:0; right:0; bottom:40px; height:6px; background: repeating-linear-gradient(90deg, #f3f4f6 0 40px, transparent 40px 80px); opacity:0.25; }

    /* Rickshaw base */
    .rickshaw { position:absolute; width:260px; height:140px; bottom:20px; left:10%; transform-origin:center; transition: transform .5s ease; }
    .rick-front { transform-origin:center; transition: transform .25s ease; }
    .wheel { transform-origin:center; animation: wheelIdle 1s linear infinite; }
    @keyframes wheelIdle { to { transform: rotate(360deg); } }

    /* drive animation */
    @keyframes driveAcross {
      0% { left:-30%; transform:scale(.85); }
      50% { left:40%; transform:scale(1.02); }
      100% { left:110%; transform:scale(.9); }
    }

    .drive { animation: driveAcross 7s linear infinite; }

    /* honk / react */
    .honk { transform: translateY(-8px) rotate(-3deg); }
    .bounce { transform: translateY(-8px) scale(1.02); }

    /* tick */
    .tickWrap{position:fixed; left:50%; top:32%; transform:translate(-50%,-50%); z-index:60; display:none;}
    .tickCircle{width:120px;height:120px;border-radius:999px;background:#10b981;display:flex;align-items:center;justify-content:center; transform:scale(.6); animation: pop .45s ease forwards;}
    @keyframes pop { from{transform:scale(.6);opacity:0} to{transform:scale(1);opacity:1}}
    .tick{width:60px;height:36px;border-left:6px solid white;border-bottom:6px solid white; transform: rotate(-45deg); margin-top:8px; margin-left:6px; opacity:0; animation: tickIn .25s .15s forwards;}
    @keyframes tickIn { to{opacity:1; transform: rotate(-45deg) translateY(0);} }

    /* modal */
    .modalBg { background: rgba(2,6,23,0.5); z-index:50; left:0; top:0; right:0; bottom:0; position:fixed; display:none; align-items:center; justify-content:center; }
    .modal { width:100%; max-width:520px; background:white;border-radius:14px;padding:18px; box-shadow:0 20px 40px rgba(2,6,23,0.12); }

    /* small helpers */
    .toast { position:fixed; right:18px; bottom:18px; z-index:70; display:none; padding:12px 16px; border-radius:10px; box-shadow:0 8px 20px rgba(2,6,23,0.12); }
    .disabled { opacity:0.6; pointer-events:none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Scene -->
    <div class="scene mb-6 p-4">
      <div class="lane"></div>
      <div id="rick" class="rickshaw drive" onclick="rickReact()">
        <!-- Realistic rickshaw SVG -->
        <svg viewBox="0 0 500 300" width="260" height="140" xmlns="http://www.w3.org/2000/svg">
          <!-- body -->
          <g>
            <rect x="40" y="70" rx="12" ry="12" width="320" height="70" fill="#047857"></rect>
            <rect x="230" y="35" rx="10" ry="10" width="120" height="55" fill="#059669"></rect>
            <path d="M40 70 q-8 -30 30 -40 h240 q30 10 30 40" fill="#065f46"></path>
            <!-- roof -->
            <rect x="60" y="20" rx="8" width="200" height="30" fill="#10b981" />
            <!-- driver seat -->
            <rect x="20" y="95" width="50" height="30" rx="6" fill="#0f172a" />
          </g>
          <!-- wheels -->
          <g>
            <circle cx="110" cy="150" r="28" fill="#0b1220"></circle>
            <circle cx="110" cy="150" r="12" fill="#f8fafc" class="wheel"></circle>
            <circle cx="310" cy="150" r="28" fill="#0b1220"></circle>
            <circle cx="310" cy="150" r="12" fill="#f8fafc" class="wheel"></circle>
          </g>
          <!-- headlights -->
          <circle cx="370" cy="100" r="8" fill="#fef3c7" opacity="0.9"/>
        </svg>
      </div>

      <div class="ground"></div>
    </div>

    <!-- App shell -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-indigo-600">Auto Earnings Tracker</h2>
        <div>
          <button id="logoutBtn" class="px-3 py-2 rounded-lg bg-red-50 text-red-600 hidden" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- LOGIN -->
      <div id="loginWrap" class="mb-4">
        <input id="pwd" placeholder="Enter password" type="password" class="w-full p-3 mb-2 border rounded-lg"/>
        <div class="flex gap-2">
          <button class="flex-1 bg-indigo-600 text-white p-3 rounded-lg" onclick="doLogin()">Login</button>
          <button class="bg-gray-100 p-3 rounded-lg" onclick="demo()">Demo</button>
        </div>
        <p id="loginMsg" class="text-red-500 mt-2 hidden"></p>
      </div>

      <!-- FORM -->
      <div id="app" class="hidden">
        <div id="todayBanner" class="hidden p-3 rounded-lg mb-3"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <div class="md:col-span-2">
            <label class="text-sm">Earning (₹)</label>
            <input id="earning" type="number" class="w-full p-3 mt-1 border rounded-lg"/>
          </div>
          <div>
            <label class="text-sm">Expense (₹)</label>
            <input id="expense" type="number" class="w-full p-3 mt-1 border rounded-lg"/>
          </div>
          <div class="md:col-span-3">
            <label class="text-sm">Reason / Notes</label>
            <textarea id="reason" rows="2" class="w-full p-3 mt-1 border rounded-lg"></textarea>
          </div>
        </div>

        <div class="flex gap-2 mb-3">
          <button id="saveBtn" class="flex-1 bg-indigo-600 text-white p-3 rounded-lg" onclick="onSaveClick()">Save</button>
          <button class="bg-gray-100 p-3 rounded-lg" onclick="loadAll()">Refresh</button>
          <button class="bg-gray-100 p-3 rounded-lg" onclick="toggleRecords()">Records</button>
        </div>

        <div class="flex gap-2 items-center mb-3">
          <input id="monthPicker" type="month" class="p-2 border rounded-lg" />
          <button class="bg-green-500 text-white p-2 rounded-lg" onclick="showMonthly()">Monthly</button>
          <div id="summary" class="ml-auto text-sm"></div>
        </div>

        <div id="recordsWrap" class="hidden overflow-auto">
          <table class="w-full table-auto">
            <thead><tr class="text-left"><th>Date</th><th>Earning</th><th>Expense</th><th>Net</th><th>Reason</th><th>Action</th></tr></thead>
            <tbody id="recordsBody" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- tick -->
  <div id="tickWrap" class="tickWrap">
    <div class="tickCircle"><div class="tick"></div></div>
  </div>

  <!-- modal -->
  <div id="modalBg" class="modalBg">
    <div class="modal">
      <h3 id="modalTitle" class="text-lg font-semibold mb-2">Confirm</h3>
      <p id="modalMsg" class="text-sm text-gray-600 mb-4">Are you sure?</p>
      <div class="flex gap-2 justify-end">
        <button onclick="closeModal()" class="px-4 py-2 rounded-lg bg-gray-100">Cancel</button>
        <button id="modalConfirmBtn" onclick="" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Yes</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast bg-white"></div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrjOUB94TUKhZuWL4Gx0BrB_3KM3Kl2J7IkCM-UawEWMD34i3sSp-tbF941ntWmghX/exec"; // <-- replace with your Web App URL
const PASSWORD = "1912";

/* ========== STATE ========== */
let allData = [];
let editingRow = null;
let editingMode = false;

/* ========== UI HELPERS ========== */
function showToast(msg, bg='linear-gradient(90deg,#fff,#fff)') {
  const t = document.getElementById('toast');
  t.style.display='block'; t.style.background = bg; t.textContent = msg;
  setTimeout(()=> t.style.display='none', 2500);
}
function showTick(){ const w=document.getElementById('tickWrap'); w.style.display='block'; setTimeout(()=> w.style.display='none',900); }
function openModal(title,msg,confirmText,cb){ document.getElementById('modalTitle').textContent=title; document.getElementById('modalMsg').textContent=msg; const bg=document.getElementById('modalBg'); bg.style.display='flex'; const btn=document.getElementById('modalConfirmBtn'); btn.textContent=confirmText||'Yes'; btn.onclick=()=>{ closeModal(); cb && cb(); }; }
function closeModal(){ document.getElementById('modalBg').style.display='none'; }

/* ========== RICK INTERACTION ========== */
function rickReact(){
  const r = document.getElementById('rick');
  r.classList.add('honk');
  setTimeout(()=> r.classList.remove('honk'), 400);
}
function rickBounce(){ const r=document.getElementById('rick'); r.classList.add('bounce'); setTimeout(()=> r.classList.remove('bounce'), 700); }

/* ========== AUTH ========== */
function demo(){ document.getElementById('pwd').value = PASSWORD; doLogin(); }
function doLogin(){
  const p = document.getElementById('pwd').value;
  if(p === PASSWORD){
    sessionStorage.setItem('ae_logged','1');
    document.getElementById('loginWrap').style.display='none';
    document.getElementById('logoutBtn').classList.remove('hidden');
    document.getElementById('app').classList.remove('hidden');
    loadAll();
    showToast('Login successful','linear-gradient(90deg,#bbf7d0,#86efac)');
  } else {
    const lm = document.getElementById('loginMsg'); lm.textContent='Wrong password'; lm.classList.remove('hidden'); setTimeout(()=> lm.classList.add('hidden'),2000);
  }
}
function logout(){ sessionStorage.removeItem('ae_logged'); document.getElementById('loginWrap').style.display='block'; document.getElementById('logoutBtn').classList.add('hidden'); document.getElementById('app').classList.add('hidden'); }

/* ========== DATA ========== */
function isoToday(){ return new Date().toISOString().slice(0,10); }

async function fetchAll(){
  try {
    const res = await fetch(SCRIPT_URL);
    const j = await res.json();
    if(Array.isArray(j)){
      allData = j.sort((a,b)=> b.date.localeCompare(a.date));
      return allData;
    } else {
      showToast('Server error','salmon');
      return [];
    }
  } catch(e){ showToast('Cannot load data: '+e,'salmon'); return []; }
}

async function loadAll(){
  await fetchAll();
  renderRecords();
  checkToday();
}

/* ========== SAVE LOGIC ========== */
async function onSaveClick(){
  const today = isoToday();
  const existing = allData.find(r=> r.date === today);
  if(existing){
    // show modal to edit
    openModal('Record exists', 'Aaj ka record pehle se hai. Kya aap ise edit karna chahte hain?', 'Edit', ()=> startEdit(existing));
    return;
  }
  submitAdd();
}

async function submitAdd(){
  const earning = document.getElementById('earning').value.trim();
  if(!earning){ showToast('Earning required','salmon'); return; }
  const expense = document.getElementById('expense').value.trim();
  const reason = document.getElementById('reason').value.trim();

  try {
    const res = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
      body: JSON.stringify({ action:'add', earning: earning, expense: expense, reason: reason })
    });
    const j = await res.json();
    if(j.status === 'ok'){
      showTick();
      rickBounce();
      showToast('Saved','linear-gradient(90deg,#7dd3fc,#60a5fa)');
      await fetchAll();
      checkToday();
      clearForm();
    } else if (j.status === 'error' && j.message === 'entry_exists') {
      // server found existing row (race condition or different client) -> show edit modal and autofill with provided data
      const existing = { row: j.existingRow, date: j.existing.date, earning: j.existing.earning, expense: j.existing.expense, reason: j.existing.reason };
      openModal('Record exists (server)', 'Aaj ka record pehle se server par hai. Kya aap ise edit karna chahte hain?', 'Edit', ()=> startEdit(existing));
    } else {
      showToast('Save error: ' + (j.message || 'unknown'),'salmon');
    }
  } catch(e){ showToast('Network error: '+e,'salmon'); }
}

/* ========== EDIT FLOW ========== */
function startEdit(record){
  // record: {row,date,earning,expense,reason}
  document.getElementById('earning').value = record.earning;
  document.getElementById('expense').value = record.expense;
  document.getElementById('reason').value = record.reason;
  editingRow = record.row;
  editingMode = true;
  document.getElementById('saveBtn').textContent = 'Update';
  document.getElementById('saveBtn').onclick = submitUpdate;
  showToast('Edit mode enabled','linear-gradient(90deg,#fde68a,#fcd34d)');
}

async function submitUpdate(){
  if(!editingRow){ showToast('No record selected to update','salmon'); return; }
  const earning = document.getElementById('earning').value.trim();
  if(earning === ''){ showToast('Earning required','salmon'); return; }
  const expense = document.getElementById('expense').value.trim();
  const reason = document.getElementById('reason').value.trim();
  try {
    const res = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
      body: JSON.stringify({ action:'update', row: editingRow, date: isoToday(), earning: earning, expense: expense, reason: reason })
    });
    const j = await res.json();
    if(j.status === 'ok'){
      showTick(); rickBounce();
      showToast('Updated','linear-gradient(90deg,#bbf7d0,#86efac)');
      editingMode = false; editingRow = null;
      document.getElementById('saveBtn').textContent = 'Save';
      document.getElementById('saveBtn').onclick = onSaveClick;
      await fetchAll(); renderRecords(); checkToday(); clearForm();
    } else {
      showToast('Update error: '+(j.message||''),'salmon');
    }
  } catch(e){ showToast('Network error: '+e,'salmon'); }
}

/* ========== UI render ========== */
function clearForm(){ document.getElementById('earning').value=''; document.getElementById('expense').value=''; document.getElementById('reason').value=''; }

function renderRecords(){
  const body = document.getElementById('recordsBody');
  body.innerHTML = '';
  allData.forEach(r=>{
    const net = Number(r.earning||0) - Number(r.expense||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="py-2 pr-4">${r.date}</td>
      <td class="py-2 pr-4">₹${Number(r.earning||0).toLocaleString('en-IN')}</td>
      <td class="py-2 pr-4">₹${Number(r.expense||0).toLocaleString('en-IN')}</td>
      <td class="py-2 pr-4 font-semibold ${net>=0?'text-green-600':'text-red-600'}">₹${net.toLocaleString('en-IN')}</td>
      <td class="py-2 pr-4">${(r.reason||'')}</td>
      <td class="py-2 pr-4"><button class="px-3 py-1 text-sm bg-indigo-600 text-white rounded" onclick="openModal('Edit','Edit this entry?','Edit', ()=> startEdit(${r.row}))">Edit</button></td>`;
    body.appendChild(tr);
  });
}

function toggleRecords(){ const w=document.getElementById('recordsWrap'); w.classList.toggle('hidden'); }

/* monthly */
function showMonthly(){
  const m = document.getElementById('monthPicker').value || new Date().toISOString().slice(0,7);
  let totE=0, totX=0, days=0;
  allData.forEach(r => { if(r.date && r.date.startsWith(m)){ totE += Number(r.earning||0); totX += Number(r.expense||0); days++; }});
  document.getElementById('summary').innerHTML = `Days:${days} Earn: ₹${totE.toLocaleString('en-IN')} Exp: ₹${totX.toLocaleString('en-IN')} Net: ₹${(totE-totX).toLocaleString('en-IN')}`;
  showToast('Monthly summary ready','linear-gradient(90deg,#bbf7d0,#86efac)');
}

/* check today's exist and update banner + disable button accordingly */
function checkToday(){
  const today = isoToday();
  const found = allData.find(r => r.date === today);
  const banner = document.getElementById('todayBanner');
  const saveBtn = document.getElementById('saveBtn');
  if(found){
    banner.classList.remove('hidden'); banner.classList.add('p-3','rounded-lg','bg-yellow-50','border','border-yellow-200');
    banner.innerHTML = `<strong>Aaj ka record hai</strong> — ₹${Number(found.earning).toLocaleString('en-IN')} earned, ₹${Number(found.expense).toLocaleString('en-IN')} expense. <button class="ml-3 px-3 py-1 text-sm rounded bg-indigo-600 text-white" onclick="openModal('Edit','Edit this entry?','Edit', ()=> startEdit({row:${found.row},date:'${found.date}',earning:${found.earning},expense:${found.expense},reason:\`${(found.reason||'').replace(/`/g,'\\`')}\`}))">Edit</button>`;
    saveBtn.textContent = 'Already saved (Edit)';
    saveBtn.classList.add('disabled');
    saveBtn.disabled = true;
  } else {
    banner.classList.add('hidden');
    saveBtn.textContent = 'Save';
    saveBtn.classList.remove('disabled');
    saveBtn.disabled = false;
  }
}

/* boot */
window.addEventListener('load', ()=>{
  if(sessionStorage.getItem('ae_logged')==='1'){ document.getElementById('loginWrap').style.display='none'; document.getElementById('logoutBtn').classList.remove('hidden'); document.getElementById('app').classList.remove('hidden'); loadAll(); }
});

</script>
</body>
</html>
